<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UvoWorld - Platform Game 2D</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Physics Engine (Matter.js) untuk game -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    
    <!-- CodeMirror untuk script editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/lua/lua.min.js"></script>
    
    <style>
        /* (Keep all previous styles, add new ones below) */
        
        /* Game Canvas Styles */
        #gameCanvas {
            border: 2px solid #00adb5;
            border-radius: 10px;
            background: #000;
            display: block;
            margin: 0 auto;
        }
        
        .game-container {
            position: relative;
            max-width: 1000px;
            margin: 20px auto;
        }
        
        .game-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 100;
        }
        
        .game-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 100;
        }
        
        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(0, 173, 181, 0.8);
            border: 2px solid white;
            color: white;
            font-size: 24px;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        @media (max-width: 768px) {
            .control-btn {
                display: flex;
            }
        }
        
        /* Studio Editor Styles */
        .studio-container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: 10px;
            height: calc(100vh - 180px);
            background: #1a1a2e;
            border-radius: 10px;
            overflow: hidden;
        }
        
        @media (max-width: 1200px) {
            .studio-container {
                grid-template-columns: 200px 1fr 250px;
            }
        }
        
        @media (max-width: 768px) {
            .studio-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
        }
        
        .studio-toolbar {
            background: #252547;
            padding: 15px;
            overflow-y: auto;
        }
        
        .studio-canvas-container {
            background: #0f0f1f;
            position: relative;
            overflow: auto;
        }
        
        #studioCanvas {
            background: #2d2d44;
            display: block;
            cursor: crosshair;
        }
        
        .studio-properties {
            background: #252547;
            padding: 15px;
            overflow-y: auto;
        }
        
        .tool-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: #3a3a6a;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .tool-btn:hover {
            background: #4a4a8a;
        }
        
        .tool-btn.active {
            background: #00adb5;
        }
        
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        .object-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background: #3a3a6a;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: move;
        }
        
        .object-item:hover {
            background: #4a4a8a;
        }
        
        .property-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            background: #3a3a6a;
            border: 1px solid #555;
            border-radius: 4px;
            color: white;
        }
        
        .layer-list {
            margin-top: 20px;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background: #3a3a6a;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        
        /* Chat System */
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 400px;
            background: rgba(26, 26, 46, 0.95);
            border: 2px solid #00adb5;
            border-radius: 10px;
            display: none;
            flex-direction: column;
            z-index: 1001;
        }
        
        .chat-container.active {
            display: flex;
        }
        
        .chat-header {
            background: #00adb5;
            padding: 10px 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            max-height: 300px;
        }
        
        .chat-input-container {
            padding: 10px;
            border-top: 1px solid #333;
        }
        
        .chat-input {
            width: 100%;
            padding: 8px;
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
            color: white;
        }
        
        .chat-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: #00adb5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            z-index: 1000;
        }
        
        /* New Game Cards */
        .game-card-large {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .game-card-large:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        
        .game-card-large img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        
        .game-card-content {
            padding: 20px;
        }
        
        .game-stats-bar {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .game-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #8a8da0;
        }
        
        /* Achievement System */
        .achievement-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid gold;
            border-radius: 20px;
            color: gold;
            font-size: 14px;
        }
        
        /* Loading Animation for Studio */
        .studio-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .progress-bar {
            width: 300px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .progress-fill {
            height: 100%;
            background: #00adb5;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* Script Editor */
        .script-editor {
            width: 100%;
            height: 300px;
            border: 1px solid #555;
            border-radius: 5px;
            overflow: hidden;
        }
        
        /* Grid Toggle */
        .grid-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
        }
        
        /* Snap Toggle */
        .snap-toggle {
            position: absolute;
            top: 50px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p style="margin-top: 20px;">Memuat UvoWorld...</p>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <i class="fas fa-gamepad"></i>
            <span>UvoWorld</span>
        </div>
        
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>
        
        <nav class="nav-menu" id="navMenu">
            <button class="nav-btn active" data-page="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-btn" data-page="game">
                <i class="fas fa-play-circle"></i>
                <span>Game</span>
            </button>
            <button class="nav-btn" data-page="studio" id="studioBtn">
                <i class="fas fa-cogs"></i>
                <span>Studio</span>
            </button>
            <button class="nav-btn" data-page="marketplace">
                <i class="fas fa-store"></i>
                <span>Market</span>
            </button>
            <button class="nav-btn" data-page="community">
                <i class="fas fa-users"></i>
                <span>Komunitas</span>
            </button>
            <button class="nav-btn" data-page="akun" id="accountBtn">
                <i class="fas fa-user"></i>
                <span>Akun</span>
            </button>
            <button class="nav-btn" id="logoutBtn" style="display: none;">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
            <div class="online-indicator" id="onlineIndicator">
                <div class="online-dot"></div>
                <span id="onlineCount">0 Online</span>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page active" id="homePage"></div>
        <div class="page" id="gamePage"></div>
        <div class="page" id="studioPage">
            <!-- Studio akan dimuat via StudioEditor.html -->
        </div>
        <div class="page" id="akunPage"></div>
        <div class="page" id="playPage"></div>
        <div class="page" id="marketplacePage"></div>
        <div class="page" id="communityPage"></div>
    </main>

    <!-- Chat Toggle Button -->
    <div class="chat-toggle-btn" id="chatToggleBtn">
        <i class="fas fa-comment"></i>
    </div>

    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <span>Chat Global</span>
            <button id="closeChatBtn" style="background: none; border: none; color: white; cursor: pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <!-- Pesan chat akan dimuat di sini -->
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ketik pesan..." maxlength="200">
        </div>
    </div>

    <!-- Mobile Game Controls (Hidden by default) -->
    <div class="game-controls" id="mobileControls" style="display: none;">
        <div class="control-btn" id="leftBtn"><i class="fas fa-arrow-left"></i></div>
        <div class="control-btn" id="rightBtn"><i class="fas fa-arrow-right"></i></div>
        <div class="control-btn" id="jumpBtn"><i class="fas fa-arrow-up"></i></div>
        <div class="control-btn" id="actionBtn"><i class="fas fa-bolt"></i></div>
    </div>

    <!-- Mobile Action Buttons -->
    <div class="mobile-actions">
        <button class="action-btn" id="mobileHomeBtn" title="Home">
            <i class="fas fa-home"></i>
        </button>
        <button class="action-btn" id="mobileGameBtn" title="Game">
            <i class="fas fa-gamepad"></i>
        </button>
        <button class="action-btn" id="mobileStudioBtn" title="Studio">
            <i class="fas fa-cogs"></i>
        </button>
        <button class="action-btn" id="mobileMarketBtn" title="Market">
            <i class="fas fa-store"></i>
        </button>
        <button class="action-btn" id="mobileAccountBtn" title="Akun">
            <i class="fas fa-user"></i>
        </button>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="logo">
                <i class="fas fa-gamepad"></i>
                <span>UvoWorld © 2024</span>
            </div>
            <div class="footer-links">
                <a href="#"><i class="fas fa-shield-alt"></i> Keamanan</a>
                <a href="#"><i class="fas fa-question-circle"></i> Bantuan</a>
                <a href="#"><i class="fas fa-file-alt"></i> Ketentuan</a>
                <a href="#"><i class="fas fa-lock"></i> Privasi</a>
            </div>
            <div id="userStatus">
                Belum login
            </div>
        </div>
    </footer>

    <script>
        // Inisialisasi Firebase dengan konfigurasi yang diberikan
        const firebaseConfig = {
            apiKey: "AIzaSyCAumGENjQDZuC6XKj2LqSNuw_Ejz7yKk0",
            authDomain: "uvoworld-1.firebaseapp.com",
            databaseURL: "https://uvoworld-1-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "uvoworld-1",
            storageBucket: "uvoworld-1.firebasestorage.app",
            messagingSenderId: "885277532590",
            appId: "1:885277532590:web:a809fb385ef500f744683f",
            measurementId: "G-5BWB5HXH7R"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
        const functions = firebase.functions();

        // State aplikasi
        let currentUser = null;
        let currentPage = 'home';
        let onlineUsers = {};
        let currentGame = null;
        let chatOpen = false;

        // Global variables untuk game engine
        window.gameEngine = {
            canvas: null,
            ctx: null,
            isRunning: false,
            players: {},
            currentLevel: null,
            physicsEngine: null
        };

        // Global variables untuk studio
        window.studio = {
            canvas: null,
            ctx: null,
            selectedTool: 'select',
            gridSize: 32,
            showGrid: true,
            snapToGrid: true,
            objects: [],
            layers: [
                { id: 'background', name: 'Background', visible: true, locked: false },
                { id: 'ground', name: 'Ground', visible: true, locked: false },
                { id: 'obstacles', name: 'Obstacles', visible: true, locked: false },
                { id: 'collectibles', name: 'Collectibles', visible: true, locked: false },
                { id: 'players', name: 'Players', visible: true, locked: false },
                { id: 'effects', name: 'Effects', visible: true, locked: false }
            ],
            currentLayer: 'ground',
            selectedObject: null
        };

        // Inisialisasi
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Cek Firebase connection
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snap) => {
                    if (snap.val() === true) {
                        console.log('Firebase connected');
                    }
                });

                // Setup event listeners
                setupEventListeners();
                
                // Initialize auth state
                await initializeAuth();
                
                // Load initial page
                await navigateTo('home');
                
                // Initialize chat system
                initializeChat();
                
                // Initialize game engine
                initializeGameEngine();
                
                console.log('UvoWorld initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Error initializing UvoWorld');
            }
        });

        function setupEventListeners() {
            // Mobile menu toggle
            mobileMenuBtn.addEventListener('click', () => {
                navMenu.classList.toggle('show');
            });

            // Navigation
            document.querySelectorAll('.nav-btn[data-page]').forEach(btn => {
                btn.addEventListener('click', () => {
                    navigateTo(btn.dataset.page);
                    if (window.innerWidth <= 768) {
                        navMenu.classList.remove('show');
                    }
                });
            });

            // Mobile navigation
            document.getElementById('mobileHomeBtn').addEventListener('click', () => navigateTo('home'));
            document.getElementById('mobileGameBtn').addEventListener('click', () => navigateTo('game'));
            document.getElementById('mobileStudioBtn').addEventListener('click', () => navigateTo('studio'));
            document.getElementById('mobileMarketBtn').addEventListener('click', () => navigateTo('marketplace'));
            document.getElementById('mobileAccountBtn').addEventListener('click', () => navigateTo('akun'));

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                auth.signOut();
                showToast('Berhasil logout');
            });

            // Chat system
            document.getElementById('chatToggleBtn').addEventListener('click', toggleChat);
            document.getElementById('closeChatBtn').addEventListener('click', toggleChat);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target.value.trim()) {
                    sendChatMessage(e.target.value);
                    e.target.value = '';
                }
            });

            // Game controls for mobile
            setupMobileControls();
        }

        function setupMobileControls() {
            const leftBtn = document.getElementById('leftBtn');
            const rightBtn = document.getElementById('rightBtn');
            const jumpBtn = document.getElementById('jumpBtn');
            const actionBtn = document.getElementById('actionBtn');

            // Touch events for mobile controls
            const addButtonEvents = (button, keyCode) => {
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    window.dispatchEvent(new KeyboardEvent('keydown', { keyCode }));
                });
                button.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    window.dispatchEvent(new KeyboardEvent('keyup', { keyCode }));
                });
                button.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    window.dispatchEvent(new KeyboardEvent('keyup', { keyCode }));
                });
            };

            if (leftBtn) addButtonEvents(leftBtn, 37); // ArrowLeft
            if (rightBtn) addButtonEvents(rightBtn, 39); // ArrowRight
            if (jumpBtn) addButtonEvents(jumpBtn, 38); // ArrowUp
            if (actionBtn) addButtonEvents(actionBtn, 32); // Space
        }

        async function initializeAuth() {
            return new Promise((resolve) => {
                auth.onAuthStateChanged(async (user) => {
                    currentUser = user;
                    
                    if (user) {
                        // Update user status
                        await updateUserStatus(true);
                        
                        // Update online status in database
                        await setOnlineStatus(true);
                        
                        // Load user data
                        await loadUserData();
                        
                        showToast(`Welcome back, ${user.displayName || user.email}!`, 2000);
                    } else {
                        await updateUserStatus(false);
                    }
                    
                    updateUIForAuthState();
                    resolve();
                });
            });
        }

        async function updateUserStatus(isOnline) {
            const userStatus = document.getElementById('userStatus');
            
            if (currentUser && isOnline) {
                const userRef = database.ref(`users/${currentUser.uid}`);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                
                userStatus.innerHTML = `
                    <i class="fas fa-user-circle"></i> ${userData?.displayName || currentUser.email}
                    <span style="color: #4CAF50;"> • Online</span>
                    ${userData?.coins ? `<span style="color: gold; margin-left: 10px;"><i class="fas fa-coins"></i> ${userData.coins}</span>` : ''}
                `;
                
                document.getElementById('logoutBtn').style.display = 'flex';
            } else {
                userStatus.innerHTML = 'Belum login';
                document.getElementById('logoutBtn').style.display = 'none';
            }
        }

        async function setOnlineStatus(isOnline) {
            if (!currentUser) return;
            
            const userStatusRef = database.ref(`status/${currentUser.uid}`);
            
            if (isOnline) {
                const isOfflineForDatabase = {
                    state: 'offline',
                    last_changed: firebase.database.ServerValue.TIMESTAMP,
                };
                
                const isOnlineForDatabase = {
                    state: 'online',
                    last_changed: firebase.database.ServerValue.TIMESTAMP,
                    user: {
                        uid: currentUser.uid,
                        displayName: currentUser.displayName,
                        email: currentUser.email
                    }
                };
                
                database.ref('.info/connected').on('value', (snapshot) => {
                    if (snapshot.val() === false) return;
                    
                    userStatusRef.onDisconnect().set(isOfflineForDatabase).then(() => {
                        userStatusRef.set(isOnlineForDatabase);
                    });
                });
                
                // Monitor online users
                database.ref('status').on('value', (snapshot) => {
                    onlineUsers = snapshot.val() || {};
                    const onlineCount = Object.keys(onlineUsers).filter(uid => onlineUsers[uid].state === 'online').length;
                    document.getElementById('onlineCount').textContent = `${onlineCount} Online`;
                });
            } else {
                userStatusRef.set({
                    state: 'offline',
                    last_changed: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        async function loadUserData() {
            if (!currentUser) return;
            
            const userRef = database.ref(`users/${currentUser.uid}`);
            const snapshot = await userRef.once('value');
            
            if (!snapshot.exists()) {
                // Create new user record
                await userRef.set({
                    email: currentUser.email,
                    displayName: currentUser.displayName || currentUser.email.split('@')[0],
                    createdAt: Date.now(),
                    coins: 1000,
                    avatar: 'fas fa-user',
                    role: 'player',
                    level: 1,
                    xp: 0,
                    achievements: [],
                    inventory: {},
                    gamesCreated: 0,
                    gamesPlayed: 0
                });
            }
            
            // Listen for real-time updates
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    // Update coins display if exists
                    const coinsElement = document.getElementById('userCoins');
                    if (coinsElement) {
                        coinsElement.textContent = userData.coins || 0;
                    }
                }
            });
        }

        function updateUIForAuthState() {
            const studioBtn = document.getElementById('studioBtn');
            const accountBtn = document.getElementById('accountBtn');
            
            if (currentUser) {
                studioBtn.style.display = 'flex';
                accountBtn.style.display = 'flex';
            } else {
                studioBtn.style.display = 'none';
                accountBtn.style.display = 'none';
            }
        }

        // Navigation system
        async function navigateTo(page, params = {}) {
            if (page === currentPage && !params.force) return;
            
            // Hide chat on navigation
            if (chatOpen) {
                toggleChat();
            }
            
            // Hide mobile controls when not in play mode
            if (page !== 'play') {
                document.getElementById('mobileControls').style.display = 'none';
            }
            
            // Validate access
            if ((page === 'studio' || page === 'akun' || page === 'marketplace') && !currentUser) {
                showToast('Harap login terlebih dahulu!');
                page = 'home';
            }
            
            // Update active button
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.page === page) {
                    btn.classList.add('active');
                }
            });
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            
            // Show selected page
            const pageElement = document.getElementById(page + 'Page');
            if (pageElement) {
                pageElement.classList.add('active');
                currentPage = page;
                
                // Load page content
                await loadPageContent(page, params);
                
                // Update mobile action buttons
                updateMobileActions();
            }
        }

        async function loadPageContent(page, params = {}) {
            showLoading();
            
            try {
                let content = '';
                
                switch(page) {
                    case 'home':
                        content = await fetchPage('Home.html');
                        break;
                    case 'game':
                        content = await fetchPage('Game.html');
                        break;
                    case 'studio':
                        content = await fetchPage('StudioEditor.html');
                        break;
                    case 'akun':
                        content = await fetchPage('Akun.html');
                        break;
                    case 'play':
                        content = await fetchPage('Play.html');
                        break;
                    case 'marketplace':
                        content = await fetchPage('Marketplace.html');
                        break;
                    case 'community':
                        content = await fetchPage('Community.html');
                        break;
                    default:
                        content = '<div style="padding: 40px; text-align: center;"><h3>Halaman tidak ditemukan</h3></div>';
                }
                
                const pageElement = document.getElementById(page + 'Page');
                pageElement.innerHTML = content;
                
                // Initialize page-specific functionality
                await initializePage(page, params);
                
            } catch (error) {
                console.error('Error loading page:', error);
                showToast('Gagal memuat halaman');
            } finally {
                hideLoading();
            }
        }

        async function fetchPage(pageName) {
            try {
                const response = await fetch(`halaman/${pageName}`);
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.text();
            } catch (error) {
                console.error('Fetch error:', error);
                return `<div style="padding: 40px; text-align: center;">
                    <h3>Error memuat halaman</h3>
                    <p>${error.message}</p>
                </div>`;
            }
        }

        async function initializePage(page, params) {
            switch(page) {
                case 'home':
                    initHomePage();
                    break;
                case 'game':
                    initGamePage();
                    break;
                case 'studio':
                    initStudioPage();
                    break;
                case 'akun':
                    initAccountPage();
                    break;
                case 'play':
                    initPlayPage(params);
                    break;
                case 'marketplace':
                    initMarketplacePage();
                    break;
                case 'community':
                    initCommunityPage();
                    break;
            }
        }

        function updateMobileActions() {
            // Hide all mobile action buttons
            document.querySelectorAll('.mobile-actions .action-btn').forEach(btn => {
                btn.style.display = 'none';
            });
            
            // Show only relevant buttons for current page
            switch(currentPage) {
                case 'play':
                    // Show game controls instead
                    document.getElementById('mobileControls').style.display = 'flex';
                    break;
                default:
                    document.querySelectorAll('.mobile-actions .action-btn').forEach(btn => {
                        btn.style.display = 'flex';
                    });
            }
        }

        // Chat System
        function initializeChat() {
            if (!currentUser) return;
            
            const chatRef = database.ref('chat/global');
            
            // Load recent messages
            chatRef.limitToLast(50).on('value', (snapshot) => {
                const messages = snapshot.val() || {};
                const chatMessages = document.getElementById('chatMessages');
                
                if (chatMessages) {
                    chatMessages.innerHTML = '';
                    
                    Object.values(messages).forEach(msg => {
                        if (msg && msg.content && msg.timestamp) {
                            const messageElement = document.createElement('div');
                            messageElement.className = 'chat-message';
                            messageElement.style.marginBottom = '8px';
                            messageElement.style.padding = '8px';
                            messageElement.style.background = 'rgba(255,255,255,0.05)';
                            messageElement.style.borderRadius = '5px';
                            
                            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            messageElement.innerHTML = `
                                <strong style="color: #00adb5;">${msg.username || 'User'}:</strong>
                                <span style="color: #fff;">${msg.content}</span>
                                <small style="color: #8a8da0; float: right;">${time}</small>
                            `;
                            
                            chatMessages.appendChild(messageElement);
                        }
                    });
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });
        }

        async function sendChatMessage(content) {
            if (!currentUser || !content.trim()) return;
            
            try {
                const chatRef = database.ref('chat/global');
                const newMessageRef = chatRef.push();
                
                await newMessageRef.set({
                    uid: currentUser.uid,
                    username: currentUser.displayName || currentUser.email.split('@')[0],
                    content: content.substring(0, 200), // Limit length
                    timestamp: Date.now()
                });
                
                // Apply basic moderation (filter bad words)
                await moderateMessage(newMessageRef.key, content);
                
            } catch (error) {
                console.error('Error sending chat:', error);
                showToast('Gagal mengirim pesan');
            }
        }

        async function moderateMessage(messageId, content) {
            // Simple profanity filter
            const badWords = ['anjing', 'babi', 'goblok', 'bangsat', 'kontol'];
            const lowerContent = content.toLowerCase();
            
            let hasBadWord = false;
            badWords.forEach(word => {
                if (lowerContent.includes(word)) {
                    hasBadWord = true;
                }
            });
            
            if (hasBadWord) {
                try {
                    const messageRef = database.ref(`chat/global/${messageId}`);
                    await messageRef.update({
                        moderated: true,
                        originalContent: content,
                        content: '[Pesan dihapus karena mengandung konten tidak pantas]'
                    });
                    
                    // Report to moderation log
                    const reportRef = database.ref('moderation/logs').push();
                    await reportRef.set({
                        type: 'chat',
                        messageId: messageId,
                        uid: currentUser.uid,
                        content: content,
                        timestamp: Date.now(),
                        action: 'auto_moderated'
                    });
                } catch (error) {
                    console.error('Moderation error:', error);
                }
            }
        }

        function toggleChat() {
            chatOpen = !chatOpen;
            const chatContainer = document.getElementById('chatContainer');
            const chatToggleBtn = document.getElementById('chatToggleBtn');
            
            if (chatOpen) {
                chatContainer.classList.add('active');
                chatToggleBtn.innerHTML = '<i class="fas fa-times"></i>';
            } else {
                chatContainer.classList.remove('active');
                chatToggleBtn.innerHTML = '<i class="fas fa-comment"></i>';
            }
        }

        // Game Engine Initialization
        function initializeGameEngine() {
            window.gameEngine = {
                canvas: null,
                ctx: null,
                isRunning: false,
                players: {},
                currentLevel: null,
                physicsEngine: null,
                gameLoop: null,
                lastTime: 0,
                
                // Physics settings
                gravity: 0.5,
                friction: 0.8,
                airResistance: 0.95,
                
                // Game objects
                platforms: [],
                obstacles: [],
                collectibles: [],
                enemies: [],
                
                // Player object
                player: {
                    x: 100,
                    y: 100,
                    width: 32,
                    height: 64,
                    velocityX: 0,
                    velocityY: 0,
                    speed: 5,
                    jumpForce: -12,
                    isOnGround: false,
                    isJumping: false,
                    facing: 'right',
                    health: 100,
                    coins: 0,
                    score: 0
                },
                
                // Input states
                keys: {
                    left: false,
                    right: false,
                    up: false,
                    space: false
                }
            };
            
            // Setup keyboard controls
            setupKeyboardControls();
        }

        function setupKeyboardControls() {
            window.addEventListener('keydown', (e) => {
                switch(e.keyCode) {
                    case 37: // Left arrow
                        gameEngine.keys.left = true;
                        break;
                    case 39: // Right arrow
                        gameEngine.keys.right = true;
                        break;
                    case 38: // Up arrow
                    case 87: // W
                        gameEngine.keys.up = true;
                        break;
                    case 32: // Space
                        gameEngine.keys.space = true;
                        break;
                }
            });
            
            window.addEventListener('keyup', (e) => {
                switch(e.keyCode) {
                    case 37: // Left arrow
                        gameEngine.keys.left = false;
                        break;
                    case 39: // Right arrow
                        gameEngine.keys.right = false;
                        break;
                    case 38: // Up arrow
                    case 87: // W
                        gameEngine.keys.up = false;
                        break;
                    case 32: // Space
                        gameEngine.keys.space = false;
                        break;
                }
            });
        }

        // Studio Initialization
        function initStudio() {
            window.studio = {
                canvas: null,
                ctx: null,
                selectedTool: 'platform',
                gridSize: 32,
                showGrid: true,
                snapToGrid: true,
                objects: [],
                selectedObject: null,
                isDrawing: false,
                startX: 0,
                startY: 0,
                
                layers: [
                    { id: 'background', name: 'Background', visible: true, locked: false },
                    { id: 'ground', name: 'Ground', visible: true, locked: false },
                    { id: 'obstacles', name: 'Obstacles', visible: true, locked: false },
                    { id: 'collectibles', name: 'Collectibles', visible: true, locked: false },
                    { id: 'players', name: 'Players', visible: true, locked: false },
                    { id: 'effects', name: 'Effects', visible: true, locked: false }
                ],
                currentLayer: 'ground',
                
                tools: [
                    { id: 'select', name: 'Select', icon: 'fas fa-mouse-pointer' },
                    { id: 'platform', name: 'Platform', icon: 'fas fa-square' },
                    { id: 'spike', name: 'Spike', icon: 'fas fa-chevron-up' },
                    { id: 'coin', name: 'Coin', icon: 'fas fa-coins' },
                    { id: 'player', name: 'Player Start', icon: 'fas fa-user' },
                    { id: 'flag', name: 'Finish Flag', icon: 'fas fa-flag' },
                    { id: 'enemy', name: 'Enemy', icon: 'fas fa-ghost' },
                    { id: 'move', name: 'Move', icon: 'fas fa-arrows-alt' },
                    { id: 'delete', name: 'Delete', icon: 'fas fa-trash' }
                ]
            };
        }

        // Utility functions
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }

        function showLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.classList.add('active');
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.classList.remove('active');
        }

        // Export functions to global scope
        window.navigateTo = navigateTo;
        window.showToast = showToast;
        window.currentUser = () => currentUser;
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;
        window.firebaseStorage = storage;

        console.log('UvoWorld Core Loaded');
    </script>
</body>
</html>
