<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ADITdeveloper — Discord Viewer</title>
<meta name="theme-color" content="#0b74de">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='4' fill='%230b74de'/%3E%3Ctext x='50%25' y='55%25' font-size='12' text-anchor='middle' fill='white' font-family='Arial' font-weight='700'%3EAD%3C/text%3E%3C/svg%3E">
<style>
:root{--bg:#0f1720;--card:#0b1220;--muted:#9aa7bf;--accent:#0b74de;--white:#eef6ff}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;background:linear-gradient(180deg,#06111a 0%,#071729 100%);color:var(--white);-webkit-font-smoothing:antialiased}
.app{display:flex;flex-direction:column;height:100vh;padding:12px}
.header{display:flex;align-items:center;gap:10px;padding:6px 8px}
.header .title{font-weight:700;font-size:16px}
.container{flex:1;display:flex;flex-direction:column;gap:10px;overflow:hidden}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:10px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
.messages{flex:1;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:8px}
.msg{display:flex;gap:10px;align-items:flex-start}
.avatar{width:44px;height:44px;border-radius:10px;flex:0 0 44px;background:linear-gradient(135deg,var(--accent),#146fbf);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
.msg-body{flex:1}
.msg-header{display:flex;gap:8px;align-items:center}
.msg-author{font-weight:700}
.msg-time{font-size:12px;color:var(--muted)}
.msg-content{margin-top:6px;color:#e6f0ff;white-space:pre-wrap;word-break:break-word}
.bottom-tabs{height:66px;display:flex;gap:8px;padding:8px}
.tab{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008));border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;font-size:13px;color:var(--muted)}
.tab.active{background:linear-gradient(180deg,var(--accent),#0a5fbf);color:var(--white)}
.controls{display:flex;gap:8px;align-items:center}
.input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white)}
.small{font-size:13px;color:var(--muted)}
.settings-grid{display:grid;grid-template-columns:1fr;gap:10px}
.btn{padding:10px 12px;border-radius:10px;background:var(--accent);border:none;color:white;font-weight:700}
.row{display:flex;gap:8px;align-items:center}
.logo-small{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,#0b74de,#146fbf);display:flex;align-items:center;justify-content:center;font-weight:700}
.footer-note{font-size:12px;color:var(--muted);text-align:center;padding:6px}
@media(min-width:720px){.app{max-width:720px;margin:0 auto}}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header">
    <div class="logo-small">AD</div>
    <div>
      <div class="title">ADITdeveloper — Discord Viewer</div>
      <div class="small" id="status">Status: not connected</div>
    </div>
    <div style="margin-left:auto" class="controls">
      <button class="btn" id="refreshBtn" title="Refresh sekarang">Refresh</button>
    </div>
  </div>

  <div class="container">
    <div id="messagesTab" class="card" style="display:block;min-height:0;flex:1;overflow:hidden">
      <div class="messages" id="messagesList" aria-live="polite"></div>
      <div class="footer-note">Pastikan Anda menyetel Relay URL di Pengaturan. Relay wajib berjalan untuk menampilkan pesan Discord.</div>
    </div>

    <div id="settingsTab" class="card" style="display:none">
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
        <div class="logo-small">AD</div>
        <div>
          <div style="font-weight:700">Pengaturan Relay</div>
          <div class="small">Masukkan URL server relay. Contoh: https://relay.example.com</div>
        </div>
      </div>
      <div class="settings-grid">
        <input id="relayUrl" class="input" placeholder="Relay URL (http(s)://domain)"/>
        <input id="channelId" class="input" placeholder="Channel ID (opsional)"/>
        <label class="small">Poll Interval (detik)</label>
        <input id="pollInterval" class="input" type="number" min="2" value="5"/>
        <div class="row">
          <button id="saveSettings" class="btn">Simpan</button>
          <button id="clearCache" class="btn" style="background:#334155">Reset Local</button>
        </div>
        <div>
          <div class="small">Webhook Test (opsional)</div>
          <input id="testWebhook" class="input" placeholder="Webhook URL untuk kirim test"/>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="sendTest" class="btn" style="background:#10b981">Kirim Test</button>
          </div>
        </div>
      </div>
    </div>

    <div id="aboutTab" class="card" style="display:none">
      <div style="display:flex;gap:10px;align-items:center">
        <div class="logo-small">AD</div>
        <div>
          <div style="font-weight:700">Tentang</div>
          <div class="small">PWA viewer pesan Discord. Gunakan relay/bot untuk membaca pesan. Bisa dibungkus jadi APK via PWABuilder.</div>
        </div>
      </div>
      <div style="margin-top:10px">
        <div class="small">Fitur</div>
        <ul class="small" style="padding-left:18px;color:var(--muted)">
          <li>Menampilkan pesan terbaru dari relay server</li>
          <li>Notifikasi Android saat pesan baru (perlu izin)</li>
          <li>3 tab bawah: Pesan / Pengaturan / Tentang</li>
          <li>Semua pengaturan tersimpan di localStorage</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="bottom-tabs">
    <div id="tabMessages" class="tab active" role="button" aria-label="Messages">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M21 15a2 2 0 0 1-2 2H8l-5 3V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round" stroke-linecap="round"/></svg>
      Pesan
    </div>
    <div id="tabSettings" class="tab" role="button" aria-label="Settings">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round" stroke-linecap="round"/><path d="M19.4 15a7 7 0 0 0 0-6l2.1-1.6-2-3.4-2.5.6a7 7 0 0 0-4-1.6L12 1h-2l-.6 2.1a7 7 0 0 0-4 1.6L2.9 4.3 1 7.7 3.1 9.3a7 7 0 0 0 0 6L1 16.9 2.9 20.3l2.5-.6a7 7 0 0 0 4 1.6L10 23h2l.6-2.1a7 7 0 0 0 4-1.6l2.5.6 1.9-3.4-2.1-1.6z" stroke="currentColor" stroke-width="1" stroke-linejoin="round" stroke-linecap="round"/></svg>
      Pengaturan
    </div>
    <div id="tabAbout" class="tab" role="button" aria-label="About">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z" stroke="currentColor" stroke-width="1" stroke-linejoin="round" stroke-linecap="round"/><path d="M11 10h2v6h-2zM12 7h.01" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round" stroke-linecap="round"/></svg>
      Tentang
    </div>
  </div>
</div>

<script>
(async function(){
  const DEFAULT_POLL = 5;
  const statusEl = document.getElementById('status');
  const messagesList = document.getElementById('messagesList');
  const relayInput = document.getElementById('relayUrl');
  const channelInput = document.getElementById('channelId');
  const pollInput = document.getElementById('pollInterval');
  const saveBtn = document.getElementById('saveSettings');
  const clearBtn = document.getElementById('clearCache');
  const refreshBtn = document.getElementById('refreshBtn');
  const sendTestBtn = document.getElementById('sendTest');
  const testWebhookInput = document.getElementById('testWebhook');

  let relay = localStorage.getItem('relay_url') || '';
  let channelId = localStorage.getItem('relay_channel') || '';
  let pollInterval = parseInt(localStorage.getItem('poll_interval') || DEFAULT_POLL,10);
  let lastMessageId = localStorage.getItem('last_msg_id') || null;
  let messages = [];

  relayInput.value = relay;
  channelInput.value = channelId;
  pollInput.value = pollInterval;
  testWebhookInput.value = '';

  function setStatus(text){
    statusEl.textContent = 'Status: ' + text;
  }

  function switchTab(tab){
    document.getElementById('messagesTab').style.display = tab==='messages'?'block':'none';
    document.getElementById('settingsTab').style.display = tab==='settings'?'block':'none';
    document.getElementById('aboutTab').style.display = tab==='about'?'block':'none';
    document.getElementById('tabMessages').classList.toggle('active', tab==='messages');
    document.getElementById('tabSettings').classList.toggle('active', tab==='settings');
    document.getElementById('tabAbout').classList.toggle('active', tab==='about');
  }

  document.getElementById('tabMessages').addEventListener('click', ()=>switchTab('messages'));
  document.getElementById('tabSettings').addEventListener('click', ()=>switchTab('settings'));
  document.getElementById('tabAbout').addEventListener('click', ()=>switchTab('about'));

  saveBtn.addEventListener('click', ()=> {
    relay = relayInput.value.trim();
    channelId = channelInput.value.trim();
    pollInterval = Math.max(2, parseInt(pollInput.value || DEFAULT_POLL,10));
    localStorage.setItem('relay_url', relay);
    localStorage.setItem('relay_channel', channelId);
    localStorage.setItem('poll_interval', pollInterval);
    setStatus('saved settings');
    startPolling();
  });

  clearBtn.addEventListener('click', ()=> {
    localStorage.clear();
    relayInput.value=''; channelInput.value=''; pollInput.value=DEFAULT_POLL;
    setStatus('local storage reset');
    location.reload();
  });

  refreshBtn.addEventListener('click', ()=> fetchOnce());

  sendTestBtn.addEventListener('click', async ()=> {
    const w = testWebhookInput.value.trim();
    if(!w) return alert('Isi webhook untuk test');
    try{
      const res = await fetch(w, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:'Test pesan dari ADITdeveloper PWA'})});
      if(res.ok) alert('Test terkirim (ke webhook).');
      else alert('Gagal kirim test: ' + res.status);
    }catch(e){ alert('Error: ' + e.message) }
  });

  function renderMessages(){
    messagesList.innerHTML = '';
    for(let m of messages.slice().reverse()){
      const el = document.createElement('div'); el.className='msg card';
      el.innerHTML = '<div class="avatar">'+escapeText((m.author && (m.author.name||m.author.username)||'U').charAt(0))+'</div>' +
      '<div class="msg-body"><div class="msg-header"><div class="msg-author">'+escapeText(m.author && (m.author.name||m.author.username) || 'Unknown')+'</div><div class="msg-time">'+formatTime(m.createdAt || m.timestamp || Date.now())+'</div></div><div class="msg-content">'+escapeText(m.content || (m.embeds && m.embeds[0] && m.embeds[0].title) || '[no text]')+'</div></div>';
      messagesList.appendChild(el);
    }
  }

  function escapeText(t){ if(!t && t!==0) return ''; return String(t).replace(/[&<>"']/g, function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];}); }

  function formatTime(v){
    const d = new Date(v);
    return d.toLocaleString('id-ID', {hour:'2-digit',minute:'2-digit',day:'2-digit',month:'short'});
  }

  async function fetchOnce(){
    const urlBase = (localStorage.getItem('relay_url') || relay).replace(/\/$/,'');
    if(!urlBase){ setStatus('relay kosong - buka Pengaturan'); return; }
    let url = urlBase + '/messages';
    const ch = (localStorage.getItem('relay_channel') || channelId);
    if(ch) url += '?channel=' + encodeURIComponent(ch);
    try{
      setStatus('mengambil...');
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) { setStatus('relay error: ' + res.status); return; }
      const data = await res.json();
      if(!Array.isArray(data)) { setStatus('relay: format tidak valid'); return; }
      setStatus('connected');
      let newMsgs = [];
      for(let m of data){
        if(!lastMessageId || m.id === lastMessageId) break;
        newMsgs.push(m);
      }
      if(newMsgs.length>0){
        messages = data.concat([]);
        lastMessageId = data[0].id;
        localStorage.setItem('last_msg_id', lastMessageId);
        renderMessages();
        for(let nm of newMsgs.reverse()){
          showNotificationFromMain(nm.author && (nm.author.name||nm.author.username) || 'Unknown', nm.content || (nm.embeds && nm.embeds[0] && nm.embeds[0].title) || '[no text]');
        }
      } else {
        messages = data.concat([]);
        renderMessages();
      }
    }catch(e){
      setStatus('fetch error');
      console.error(e);
    }
  }

  let pollTimer = null;
  function startPolling(){
    clearInterval(pollTimer);
    pollTimer = setInterval(fetchOnce, (parseInt(localStorage.getItem('poll_interval')||pollInterval,10))*1000);
    fetchOnce();
  }
  function stopPolling(){ if(pollTimer) clearInterval(pollTimer); pollTimer=null; }

  let swReg = null;
  async function initServiceWorker(){
    if('serviceWorker' in navigator){
      try{
        const swCode = "self.addEventListener('install', event => {self.skipWaiting();});self.addEventListener('activate', event => {self.clients.claim();});self.addEventListener('message', event => {const data = event.data; if(data && data.type === 'show-notification'){const title = data.title || 'Pesan baru'; const options = {body: data.body || '',tag: data.tag||Date.now().toString(),icon: data.icon||'',badge: data.badge||'',data:data}; self.registration.showNotification(title, options);}});self.addEventListener('notificationclick', event => {event.notification.close(); event.waitUntil(clients.matchAll({type:'window',includeUncontrolled:true}).then(all=>{ if(all.length>0) return all[0].focus(); return clients.openWindow('/'); }));});";
        const blob = new Blob([swCode], {type:'application/javascript'});
        const swUrl = URL.createObjectURL(blob);
        swReg = await navigator.serviceWorker.register(swUrl);
      }catch(err){ console.warn('SW error', err); }
    }
  }

  async function requestPermission(){
    if(!('Notification' in window)) return;
    if(Notification.permission === 'default'){
      try{ await Notification.requestPermission(); } catch(e){ console.warn(e); }
    }
  }

  function showNotificationFromMain(title, body){
    if(Notification.permission !== 'granted') return;
    if(navigator.serviceWorker && navigator.serviceWorker.controller){
      navigator.serviceWorker.controller.postMessage({type:'show-notification', title, body});
    } else if(swReg){
      swReg.active && swReg.active.postMessage({type:'show-notification', title, body});
    } else {
      try { new Notification(title, {body}); } catch(e){ console.warn(e); }
    }
  }

  await initServiceWorker();
  await requestPermission();
  if(!relay && !localStorage.getItem('relay_url')) setStatus('relay belum diset - buka Pengaturan');
  else { setStatus('ready'); startPolling(); }

  window.addEventListener('storage', (e)=> { if(e.key === 'poll_interval') startPolling(); });

  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){ stopPolling(); pollTimer = setInterval(fetchOnce, Math.max(10, (localStorage.getItem('poll_interval')||pollInterval)*4)*1000); }
    else { startPolling(); fetchOnce(); }
  });

  setInterval(()=>{ if(document.visibilityState!=='hidden') fetchOnce(); }, 10000);

})();
</script>

<script>
(async function(){
  const manifest = {
    name: "ADITdeveloper — Discord Viewer",
    short_name: "ADIT Discord",
    start_url: ".",
    display: "standalone",
    orientation: "portrait",
    background_color: "#071729",
    theme_color: "#0b74de",
    icons: [
      {src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%230b74de'/%3E%3Ctext x='50%25' y='55%25' font-size='64' text-anchor='middle' fill='white' font-family='Arial' font-weight='700'%3EAD%3C/text%3E%3C/svg%3E", sizes:"128x128", type:"image/svg+xml"}
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('link'); link.rel='manifest'; link.href = url;
  document.head.appendChild(link);
})();
</script>

</body>
</html>
